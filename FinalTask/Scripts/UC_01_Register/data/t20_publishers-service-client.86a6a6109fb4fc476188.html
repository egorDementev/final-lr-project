"use strict";(self.webpackChunk_msnews_msnews_experiences=self.webpackChunk_msnews_msnews_experiences||[]).push([["msnews/publishers-service-client"],{31983:function(e,t,s){var i;s.d(t,{S:function(){return i},PublisherServiceClient:function(){return f}}),function(e){e.More="More",e.Mute="Mute",e.Read="Read"}(i||(i={}));var r=s(89315),a=s(39157),n=s(13334),o=s(15165),d=s(54820),u=s(44672),c=s(83089),h=s(90158),l=s(11599),p=s(801),g=s(5674),w=s(83102),y=s(70169);class f{constructor(e,t=!0){this.fetchImpl=e,this.addPageInfoToOcid=t,this.followedPublishersEndpoint="v1/News/Users/Me/PreferredProviders",this.followedSourcesEndpoint="msn/sources",this.publishersServiceEndpoint="Msn/Providers",this.actionsServiceEndpoint="Graph/Actions",this.followActionSourceEndpoint="community/follows",this.ocid="feeds"}getOcid(){return this.ocid}async getUserMutedPublishers(){const e=await this.getUserActions(i.Mute);if(!e||!e.value)return null;if(!e.value.length)return[];const t=e.value.reduce(((e,t)=>(e[t.targetId]=t,e)),{}),s=await this.getPublisherDetails(Object.keys(t));if(!s||!s.value||!s.value.length)return null;return s.value.map((e=>{const s={createdDateTime:t[e.id].createdDateTime};return{...e,...s}}))}async getUserFollowedPublishers(e=100){const t=await this.getRequestInit(),s=[...await this.getCommonParams(),{key:"$top",value:`${e}`}],i=(0,o.PH)(this.followedPublishersEndpoint);this.appendQs(s,i),(0,r.aH)()||(0,g.s6)(i);const a=await this.sendRequest(decodeURIComponent(i.href),t,"getFollowedPublishers");return a?.value}async getUserFollowedSources(e=100){const t=await this.getRequestInit(),s=[...await this.getCommonParams(),{key:"$top",value:`${e}`},{key:"queryType",value:"MyFeed"}],i=(0,o.PH)(this.followedSourcesEndpoint);let a;this.appendQs(s,i),(0,r.aH)()||(0,g.s6)(i);try{a=await this.sendRequest(decodeURIComponent(i.href),t,"getFollowedSources")}catch(e){throw new Error(`{url: ${i.href}}`)}return a?.value?.length>0?a?.value[0]?.subCards.map((e=>{const t=e.intAttributes&&1==e.intAttributes.disableProfile;return{...e,profileId:t?null:e.profileId,displayName:e.name,logos:[{imageLink:{href:e.image?.url}}]}})):[]}async publisherUserAction(e,t,s){if(!e||!t)return null;const i=await this.getRequestInit();i.method=s;let r=await this.getCommonParams();"POST"===s?i.body=JSON.stringify({actionType:t,targetId:e,targetType:"SourceProvider"}):"DELETE"===s&&(r=[...r,{key:"$filter",value:`actionType eq '${t}' and targetId eq '${e}'`}]);const a=(0,o.PH)(this.actionsServiceEndpoint);this.appendQs(r,a);const n=await this.sendRequest(decodeURIComponent(a.href),i,`deleteUserAction ${t}`,!0,!0);if(n.status>=400){const s=`OneService returned error response. Status: ${n.status} for actionType: ${t}, targetId: ${e}`;throw new Error(s)}return n}async updateSourceFollowState(e,t){if(!e)return null;const s=await this.getRequestInit();let i=await this.getCommonParams();i=[...i],t?(s.method="POST",s.body=JSON.stringify({targetId:e})):(s.method="DELETE",i=[...i,{key:"targetId",value:e}]);const r=(0,o.PH)(this.followActionSourceEndpoint);this.appendQs(i,r);const a=t?"follow":"unfollow";try{return await this.sendRequest(decodeURIComponent(r.href),s,`updateSourceFollowState ${a}`,!0,!0)}catch(t){throw new Error(`OneService returned error response. Community follow service  for targetId: ${e}, action: ${a}`)}}async updatePublisherReadTime(e,t,s){if(!e)return null;const r=await this.getRequestInit(),a=await this.getCommonParams(),n=i.Read;r.method="POST",r.body=JSON.stringify({actionType:n,targetType:s,targetId:e,updatedDateTime:t});const d=(0,o.PH)(this.actionsServiceEndpoint);this.appendQs(a,d);try{return await this.sendRequest(decodeURIComponent(d.href),r,`updateSourceReadTime ${n}`,!0,!0)}catch(t){throw new Error(`OneService returned error response for actionType: ${n}, targetId: ${e}`)}}async getUserPublishersReadTimes(){try{const e=await this.generatePublisherStatusRequest(void 0,i.Read);return e?.value}catch(e){throw new Error("OneService returned error response for fetching followed sources read times.")}}async getUserPublisherStatus(e,t){const s=await this.generatePublisherStatusRequest(e,t);return!!s.value?.length}async generatePublisherStatusRequest(e,t){const s=await this.getRequestInit();s.method="GET";const i=e?`and targetId eq '${e}'`:"";let a=await this.getCommonParams();a=[...a,{key:"$filter",value:`actionType eq '${t}' ${i} `}];const n=(0,o.PH)(this.actionsServiceEndpoint);return this.appendQs(a,n),(0,r.aH)()||(0,g.s6)(n),await this.sendRequest(decodeURIComponent(n.href),s,`getUserPublisherStatus ${t}`)}async getUserActions(e,t=100){const s=await this.getRequestInit(),i=[...await this.getCommonParams(),{key:"$filter",value:`actionType eq '${e}' and deleted eq false and targetType eq 'SourceProvider'`},{key:"$top",value:`${t}`}],a=(0,o.PH)(this.actionsServiceEndpoint);return this.appendQs(i,a),(0,r.aH)()||(0,g.s6)(a),await this.sendRequest(decodeURIComponent(a.href),s,`getUserActions ${e}`)}async getPublisherDetails(e){const t=await this.getRequestInit(),s=(0,o.PH)(this.publishersServiceEndpoint),i=[...d.$D.getOneServiceParamsWithoutAuth(null,this.ocid,this.addPageInfoToOcid),{key:"ids",value:e.join(",")}];return this.appendQs(i,s),await this.sendRequest(decodeURIComponent(s.href),t,"getPublisherDetails")}async getCommonParams(){if("winWidgets"===a.jG.AppType&&(this.ocid="sidebar"===n.Al.ClientSettings?.pagetype?"shoreline":"winp2",this.addPageInfoToOcid=!1),(0,r.aH)())return this.getSapphireQueryParams();this.forcedApiKey&&(this.addPageInfoToOcid=!1),(0,r._3)()&&(this.ocid="OnOSkypeChannels");const e=await this.isUserSignedIn()?d.$D.getOneServiceParamsWithAuth(a.jG.UserId||a.jG.ActivityId,this.ocid,this.addPageInfoToOcid):d.$D.getOneServiceParamsWithoutAuth(a.jG.UserId||a.jG.ActivityId,this.ocid,this.addPageInfoToOcid);if(this.forcedApiKey){e.find((e=>"apikey"==e.key)).value=this.forcedApiKey}return e}getSapphireQueryParams(){const e=d.$D.getOneServiceNonDynamicParamsWithoutAuth(this.ocid,this.addPageInfoToOcid),t=(0,c._4)();return t&&(e.push({key:a.jG.OneServiceContentMarketQspKey,value:t.market}),a.jG.ShouldUseFdheadQsp&&e.push({key:"fdhead",value:t.features}),e.push({key:"activityId",value:t.activityId}),t.latitude&&t.longitude&&e.push({key:"location",value:`${t.latitude}|${t.longitude}`})),e}async getRequestInit(e=null){return null==e&&(e={method:"GET"}),e.credentials="include",e.headers=(0,h.wq)()?await(0,l.dG)():await d.$D.getOneServiceHeaders(),e}async isUserSignedIn(){const e=(0,n.nP)().UserIsSignedIn;if(void 0!==e)return e;return await(0,y.XJ)()===w.Hy.SignedIn}async sendRequest(e,t,s,i,a){return(0,r.aH)()?await this.sapphireRequest(decodeURIComponent(e),t):await this.networkRequest(decodeURIComponent(e),t,s,i,a)}async sapphireRequest(e,t){const s={url:e,headers:t.headers,body:t.body,refresh:!0};let i;switch(t.method){case"POST":i=await(0,p.Ef)(s);break;case"DELETE":i=await(0,p.o9)(s);break;default:i=await(0,p.FM)(s)}return JSON.parse(i||"{}")}async networkRequest(e,t,s,i,r){return(0,u.w)((async()=>{const s=await this.fetchImpl(e,t);if(!s.ok)throw Error(s.statusText);return i&&(0,g.T1)(),r?s:s.json()}),s)}appendQs(e,t){e.forEach((e=>{e.value&&t.searchParams.set(e.key,e.value)}))}setForcedApiKey(e){this.forcedApiKey=e}}}}]);